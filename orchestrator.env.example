# ============================================================================
# DAG Orchestrator Environment Variables
# ============================================================================
# Copy this file to orchestrator.env and fill in values for local testing.
# For Azure deployment, set these in Web App configuration.
#
# Usage:
#   docker run --env-file orchestrator.env rmhdagmaster:latest
#
# Created: 29 JAN 2026 (Epoch 5)
# ============================================================================

# =============================================================================
# APP MODE
# =============================================================================
APP_MODE=orchestrator
APP_NAME=dag-orchestrator
ENVIRONMENT=dev

# =============================================================================
# MANAGED IDENTITY AUTHENTICATION (Required for Azure)
# =============================================================================
# User-assigned managed identity is RECOMMENDED over system-assigned because:
# - Can be pre-created and assigned RBAC roles before deployment
# - Same identity can be shared across multiple containers
# - Survives container recreation
#
# Prerequisites:
# 1. Create user-assigned managed identity in Azure Portal
# 2. Assign to Web App (Settings > Identity > User assigned)
# 3. Grant RBAC roles:
#    - PostgreSQL: Create database user matching identity name
#    - Storage: Storage Blob Data Contributor on storage accounts
#    - Service Bus: Azure Service Bus Data Sender on namespace (for dispatching)
# 4. Set the variables below

USE_MANAGED_IDENTITY=true

# Client ID of the user-assigned managed identity (from Azure Portal)
# Format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_ID=

# PostgreSQL user name (must match the identity name in database)
# This is created via: SELECT * FROM pgaadauth_create_principal('identity-name', false, false);
DB_ADMIN_MANAGED_IDENTITY_NAME=

# =============================================================================
# DATABASE (Required)
# =============================================================================
# For UMI auth (production)
POSTGRES_HOST=rmhpostgres.postgres.database.azure.com
POSTGRES_DB=postgres
POSTGRES_PORT=5432

# For password auth (LOCAL DEVELOPMENT ONLY - not recommended for production)
# POSTGRES_USER=your-admin-user
# POSTGRES_PASSWORD=your-password
# USE_MANAGED_IDENTITY=false

# Or use full connection string (overrides individual vars)
# DATABASE_URL=postgresql://user:pass@host:5432/dbname?sslmode=require

# =============================================================================
# SCHEMA BOOTSTRAP (Auto-DDL on startup)
# =============================================================================
# When true, orchestrator will deploy dagapp schema on startup if not exists
# Safe to leave enabled - operations are idempotent (IF NOT EXISTS)
AUTO_BOOTSTRAP_SCHEMA=true

# =============================================================================
# STORAGE ACCOUNTS (Medallion Architecture)
# =============================================================================
# Storage account names (without .blob.core.windows.net)
# Must have Storage Blob Data Contributor role assigned to managed identity

# Bronze = raw uploads (rmhazuregeo)
BRONZE_STORAGE_ACCOUNT=rmhazuregeo

# Silver = processed data (rmhstorage123)
SILVER_STORAGE_ACCOUNT=rmhstorage123

# =============================================================================
# SERVICE BUS (Required for task dispatch)
# =============================================================================
# IMPORTANT: Use SERVICE_BUS_FQDN (full domain)
# Must include: yournamespace.servicebus.windows.net

SERVICE_BUS_FQDN=rmhazure.servicebus.windows.net

# For connection string auth (local development only)
# SERVICEBUS_CONNECTION_STRING=Endpoint=sb://...

# Queue names (defaults shown - only override if using custom names)
DAG_WORKER_QUEUE=dag-worker-tasks
DAG_RESULT_QUEUE=dag-task-results

# Callback URL for workers to report results (optional - workers can POST directly)
# DAG_CALLBACK_URL=https://rmhdagmaster.azurewebsites.net/api/v1/callbacks/task-result

# =============================================================================
# ORCHESTRATOR SETTINGS
# =============================================================================
# Polling interval for orchestration loop (seconds)
ORCHESTRATOR_POLL_INTERVAL=1.0

# Directory containing workflow YAML files
WORKFLOWS_DIR=/app/workflows

# =============================================================================
# OBSERVABILITY (Recommended)
# =============================================================================
# Application Insights connection string (from Azure Portal)
# IMPORTANT: Use same App Insights as rmhgeoapi for unified logging
APPLICATIONINSIGHTS_CONNECTION_STRING=

# For AAD-based App Insights auth (recommended)
APPLICATIONINSIGHTS_AUTHENTICATION_STRING=Authorization=AAD

LOG_LEVEL=INFO

# =============================================================================
# WEB SERVER
# =============================================================================
HOST=0.0.0.0
PORT=8000
