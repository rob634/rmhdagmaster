{% extends "base.html" %}
{% from "partials/status_badge.html" import badge %}

{% block title %}Job {{ job.job_id[:8] }} - DAG Orchestrator{% endblock %}

{% block page_title %}Job Details{% endblock %}

{% block content %}
<!-- Job Header -->
<div class="job-header">
    <div>
        <h1 class="job-title">
            <code>{{ job.job_id }}</code>
        </h1>
        <div class="job-meta">
            <span class="job-meta-item">
                <i data-feather="git-branch"></i>
                {{ job.workflow_id }}
            </span>
            <span class="job-meta-item">
                <i data-feather="clock"></i>
                Created {{ job.created_at | default('-') }}
            </span>
            {% if job.entity_id %}
            <span class="job-meta-item">
                <i data-feather="database"></i>
                Entity: {{ job.entity_id[:12] }}...
            </span>
            {% endif %}
        </div>
    </div>
    <div style="display: flex; gap: 12px; align-items: flex-start;">
        {{ badge(job.status, 'lg') }}
        <a href="/ui/jobs/{{ job.job_id }}/timeline" class="btn btn-secondary">
            <i data-feather="activity"></i>
            Timeline
        </a>
        {% if job.status == 'running' %}
        <button class="btn btn-secondary" onclick="cancelJob('{{ job.job_id }}')" data-confirm="Cancel this job?">
            <i data-feather="x"></i>
            Cancel
        </button>
        {% endif %}
    </div>
</div>

<!-- Progress Overview -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-label">Total Nodes</span>
            <div class="stat-icon">
                <i data-feather="circle"></i>
            </div>
        </div>
        <div class="stat-value">{{ nodes | length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-label">Completed</span>
            <div class="stat-icon">
                <i data-feather="check-circle"></i>
            </div>
        </div>
        <div class="stat-value text-success">{{ nodes | selectattr('status', 'equalto', 'completed') | list | length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-label">Running</span>
            <div class="stat-icon">
                <i data-feather="play-circle"></i>
            </div>
        </div>
        <div class="stat-value text-info">{{ nodes | selectattr('status', 'equalto', 'running') | list | length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-header">
            <span class="stat-label">Failed</span>
            <div class="stat-icon">
                <i data-feather="x-circle"></i>
            </div>
        </div>
        <div class="stat-value text-danger">{{ nodes | selectattr('status', 'equalto', 'failed') | list | length }}</div>
    </div>
</div>

<!-- Input Parameters -->
{% if job.input_params %}
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Input Parameters</h3>
    </div>
    <div class="card-body">
        <pre style="background: var(--color-bg-tertiary); padding: 16px; border-radius: var(--border-radius); overflow-x: auto; margin: 0;">{{ job.input_params | tojson(indent=2) }}</pre>
    </div>
</div>
{% endif %}

<!-- Node Execution -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Node Execution</h3>
    </div>
    <div class="card-body">
        {% if nodes %}
        <div class="node-list">
            {% for node in nodes %}
            <div class="node-item">
                <div class="node-status {{ node.status }}">
                    {% if node.status == 'completed' %}
                        <i data-feather="check"></i>
                    {% elif node.status == 'running' %}
                        <i data-feather="loader"></i>
                    {% elif node.status == 'failed' %}
                        <i data-feather="x"></i>
                    {% elif node.status == 'dispatched' %}
                        <i data-feather="send"></i>
                    {% elif node.status == 'ready' %}
                        <i data-feather="arrow-right"></i>
                    {% elif node.status == 'skipped' %}
                        <i data-feather="skip-forward"></i>
                    {% else %}
                        <i data-feather="clock"></i>
                    {% endif %}
                </div>
                <div class="node-info">
                    <div class="node-name">{{ node.node_id }}</div>
                    <div class="node-handler">
                        Handler: <code>{{ node.handler | default('-') }}</code>
                        {% if node.depends_on %}
                        <span class="text-muted"> | Depends on: {{ node.depends_on | join(', ') }}</span>
                        {% endif %}
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    {{ badge(node.status) }}
                    <div class="node-timing">
                        {% if node.duration_ms %}
                            {{ (node.duration_ms / 1000) | round(2) }}s
                        {% elif node.started_at %}
                            Started {{ node.started_at }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Node Error (if failed) -->
            {% if node.status == 'failed' and node.error_message %}
            <div style="margin-left: 56px; margin-top: -8px; margin-bottom: 12px;">
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--border-radius); padding: 12px;">
                    <strong class="text-danger">Error:</strong>
                    <pre style="margin: 8px 0 0 0; white-space: pre-wrap; color: var(--color-text-muted);">{{ node.error_message }}</pre>
                </div>
            </div>
            {% endif %}

            <!-- Node Output (if completed) -->
            {% if node.status == 'completed' and node.output %}
            <div style="margin-left: 56px; margin-top: -8px; margin-bottom: 12px;">
                <details>
                    <summary style="cursor: pointer; color: var(--color-text-muted); font-size: 13px;">
                        View Output
                    </summary>
                    <pre style="background: var(--color-bg-tertiary); padding: 12px; border-radius: var(--border-radius); overflow-x: auto; margin-top: 8px; font-size: 12px;">{{ node.output | tojson(indent=2) }}</pre>
                </details>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i data-feather="circle"></i>
            <div class="empty-state-title">No nodes</div>
            <div class="empty-state-description">This job has no node execution data.</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Task History -->
{% if tasks %}
<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">Task History</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Task ID</th>
                        <th>Node</th>
                        <th>Status</th>
                        <th>Worker</th>
                        <th>Duration</th>
                        <th>Completed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td><code>{{ task.task_id[:16] }}...</code></td>
                        <td>{{ task.node_id }}</td>
                        <td>{{ badge(task.status) }}</td>
                        <td class="text-muted">{{ task.worker_id | default('-') }}</td>
                        <td>
                            {% if task.execution_duration_ms %}
                                {{ (task.execution_duration_ms / 1000) | round(2) }}s
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ task.completed_at | default('-') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Back Link -->
<div class="mt-4">
    <a href="/ui/jobs" class="btn btn-secondary">
        <i data-feather="arrow-left"></i>
        Back to Jobs
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh if job is still running
    {% if job.status == 'running' %}
    setInterval(function() {
        if (!document.hidden) {
            location.reload();
        }
    }, 5000);
    {% endif %}
</script>
{% endblock %}
