# H3 Road Network Synthesis from Overture Maps

## Concept

Traditional traffic analytics (Uber's approach) observe real GPS traces and infer road network topology. This project inverts that pattern: we start with known road network topology (Overture Maps) and synthesize "observations" that encode connectivity and hierarchy into an H3 transition matrix.

The result is a road network represented as weighted transitions between H3 cells—the same data structure that would emerge from billions of GPS observations, but derived from authoritative map data.

### What This Enables

- **Accessibility analysis** at any scale using H3 spatial operations
- **Flood impact modeling** by zeroing transitions for inundated cells
- **Network resilience analysis** without dedicated routing infrastructure
- **Hybrid with real data** — synthetic network as prior, empirical data as updates

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                        DAG BRAIN                                 │
│  - Monitors job queue (Postgres)                                │
│  - Resolves dependencies                                        │
│  - Dispatches tasks to Service Bus                              │
│  - Tracks completion, handles failures                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Service Bus Queue
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DAG WORKERS (1-30 instances)                 │
│  - Pull tasks from queue                                        │
│  - Execute task (DuckDB read, H3 transform, PostGIS write)      │
│  - Report completion                                            │
│  - Stateless, identical, scalable                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         POSTGRES                                 │
│  - Job/task state tables (DAG Brain state)                      │
│  - Staging tables (intermediate results)                        │
│  - Final H3 transition tables                                   │
│  - h3-pg extension for spatial indexing                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Workflow 1: Build Road Network Transition Matrix

**Purpose:** Transform Overture road segments into H3 cell-to-cell transitions with weights based on road classification.

### DAG Structure

```
[init_staging]
      │
      ▼
[generate_chunks] ──────────────────────────────┐
      │                                         │
      ▼                                         │
┌─────────────────────────────────────────┐     │
│  [process_chunk_001]                    │     │
│  [process_chunk_002]                    │     │
│  [process_chunk_003]                    │     │  PARALLEL
│       ...                               │     │  (foreach chunk)
│  [process_chunk_N]                      │     │
└─────────────────────────────────────────┘     │
      │                                         │
      ▼ ◄───────────────────────────────────────┘
[aggregate_transitions]
      │
      ▼
[compute_probabilities]
      │
      ▼
[create_indexes]
      │
      ▼
[cleanup_staging]
```

### Node Specifications

#### init_staging
- **Type:** SQL execution
- **Dependencies:** None
- **Action:** Create staging schema and raw transitions table
- **Idempotent:** Yes (DROP IF EXISTS)

#### generate_chunks
- **Type:** Computation
- **Dependencies:** init_staging
- **Inputs:** Area of interest bounds, chunk size in degrees
- **Outputs:** List of bounding boxes (stored as job metadata)
- **Notes:** Filter to land areas only if global scope

#### process_chunk (parallel, foreach)
- **Type:** Worker task
- **Dependencies:** generate_chunks
- **Inputs:** Single bounding box, H3 resolution, target staging table
- **Action:**
  1. DuckDB query to Overture parquet (direct from cloud storage)
  2. For each road segment: sample points, convert to H3 cells, generate transitions
  3. Weight transitions by road class
  4. Bulk insert to staging table
- **Outputs:** Row count written
- **Parallelism:** One task per chunk, all run concurrently

#### aggregate_transitions
- **Type:** SQL execution
- **Dependencies:** ALL process_chunk tasks complete
- **Action:** GROUP BY (from_cell, to_cell), SUM weights
- **Notes:** This is the fan-in point

#### compute_probabilities
- **Type:** SQL execution  
- **Dependencies:** aggregate_transitions
- **Action:** Calculate transition probability as weight / sum of outgoing weights per cell

#### create_indexes
- **Type:** SQL execution
- **Dependencies:** compute_probabilities
- **Action:** B-tree indexes on from_cell, to_cell; consider BRIN for range queries

#### cleanup_staging
- **Type:** SQL execution
- **Dependencies:** create_indexes
- **Action:** Drop staging schema

### Road Class Weights

Suggested starting weights (tunable):

| Overture Class | Weight | Rationale |
|----------------|--------|-----------|
| motorway       | 1000   | High capacity, high speed |
| trunk          | 500    | Major arterial |
| primary        | 200    | Primary roads |
| secondary      | 100    | Secondary roads |
| tertiary       | 50     | Tertiary roads |
| residential    | 10     | Local access |
| service        | 5      | Parking lots, driveways |

### Output Schema

```sql
TABLE h3_road_transitions (
    from_cell       h3index,
    to_cell         h3index,
    total_weight    integer,
    road_classes    text[],
    probability     float
)
```

---

## Workflow 2: H3 Aggregation and Analysis

**Purpose:** Use the transition matrix for spatial analysis, accessibility computation, and hazard impact modeling.

### DAG Structure (Example: Flood Impact Analysis)

```
[load_hazard_data]
      │
      ├──────────────────────┐
      ▼                      ▼
[h3_index_hazard]    [load_transition_matrix]
      │                      │
      └──────────┬───────────┘
                 ▼
         [compute_impacted_network]
                 │
                 ▼
         [accessibility_analysis]
                 │
                 ▼
         [generate_outputs]
```

### Analysis Patterns

#### Basic: Remove flooded cells

```sql
-- Network with flooded cells removed
SELECT from_cell, to_cell, probability
FROM h3_road_transitions
WHERE from_cell NOT IN (SELECT cell FROM flooded_cells)
  AND to_cell NOT IN (SELECT cell FROM flooded_cells);
```

#### Intermediate: Degrade partially flooded routes

```sql
-- Reduce probability for cells with shallow flooding
UPDATE h3_road_transitions t
SET probability = probability * (1 - f.severity)
FROM flood_severity f
WHERE t.from_cell = f.cell OR t.to_cell = f.cell;
```

#### Advanced: Accessibility index

```sql
-- Cells reachable within N hops from origin, weighted by probability
WITH RECURSIVE reachable AS (
    SELECT 
        to_cell as cell,
        probability as cumulative_prob,
        1 as hops
    FROM h3_road_transitions
    WHERE from_cell = :origin_cell
    
    UNION ALL
    
    SELECT 
        t.to_cell,
        r.cumulative_prob * t.probability,
        r.hops + 1
    FROM reachable r
    JOIN h3_road_transitions t ON r.cell = t.from_cell
    WHERE r.hops < :max_hops
      AND r.cumulative_prob * t.probability > :min_probability
)
SELECT cell, MAX(cumulative_prob) as accessibility
FROM reachable
GROUP BY cell;
```

---

## Implementation Notes

### DuckDB + Overture

Workers read Overture directly from cloud storage:

```python
duckdb.sql("""
    SELECT id, class, geometry
    FROM read_parquet('s3://overturemaps-us-west-2/release/2024-*/theme=transportation/*')
    WHERE bbox.xmin >= ? AND bbox.ymin >= ? AND bbox.xmax <= ? AND bbox.ymax <= ?
      AND type = 'segment'
""")
```

No local data staging required. DuckDB handles predicate pushdown.

### H3 Resolution Selection

| Resolution | Hex Edge | Use Case |
|------------|----------|----------|
| 7          | ~1.2 km  | Continental/global, coarse analysis |
| 8          | ~460 m   | National scale, general routing |
| 9          | ~175 m   | Regional, distinguishes parallel roads |
| 10         | ~65 m    | Urban detail, intersection-level |

Recommend starting with resolution 8 for tractability, refine to 9 for urban areas.

### Handling One-Way Streets

Overture includes directional information. Modify transition generation:

```python
if road.is_oneway:
    # Only forward direction
    transitions.append((from_cell, to_cell, weight))
else:
    # Bidirectional
    transitions.append((from_cell, to_cell, weight))
    transitions.append((to_cell, from_cell, weight))
```

### Chunk Sizing

| Scope | Chunk Size | Approx Chunks | Est. Runtime (30 workers) |
|-------|------------|---------------|---------------------------|
| Single country | 0.25° | 50-200 | < 30 min |
| Continental | 0.5° | 500-1000 | 2-4 hours |
| Global | 0.5° | 3000-4000 | 6-10 hours |

---

## Infrastructure Requirements

### DAG Brain (Orchestrator)
- Single Docker Web App instance
- Polls Postgres for job state
- Dispatches tasks to Service Bus
- Minimal compute, mostly I/O wait

### DAG Workers
- Docker Web App, scale 1-30 instances
- Fat container image with DuckDB, GDAL, Python, h3 library
- Pulls tasks from Service Bus queue
- Writes results to Postgres
- Stateless, interchangeable

### Postgres
- h3-pg extension installed
- Sufficient storage for transition table (~1-10 GB depending on resolution and scope)
- Connection pooling for concurrent worker writes

### Service Bus
- Single queue for task dispatch
- Workers compete for tasks (automatic load distribution)

---

## Success Criteria

1. **Workflow 1 completes** for target geography at chosen resolution
2. **Transition table** is queryable with reasonable performance (< 1s for single-cell neighborhood)
3. **Flood overlay** correctly zeros transitions for inundated cells
4. **Accessibility query** returns plausible results (reachable cells form connected regions along roads)

---

## Future Extensions

- **Temporal weighting:** Different weights for rush hour vs off-peak
- **Real data fusion:** Incorporate actual traffic observations where available
- **Multi-modal:** Add transit, cycling, pedestrian networks as separate layers
- **Dynamic updates:** Incremental refresh when Overture releases new data
- **API exposure:** Serve transition queries via TiTiler or custom endpoint